﻿<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
</head>
<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
    }

    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        height: 80%; /* = 100% of the .modal-dialog block */
    }

    /* The Close Button */
    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

    p.header {
        font-family: Tahoma, Geneva, sans-serif;
    }

    button {
        background-color: #4CAF50;
        color: white;
        padding: 14px 20px;
        margin: 8px 0;
        border: none;
        cursor: pointer;
        width: 5%;
        align-items: center;
    }

        button:hover {
            opacity: 0.8;
        }

    a {
        text-decoration: none;
        display: inline-block;
        padding: 8px 16px;
    }

        a:hover {
            background-color: #ddd;
            color: black;
        }

    .previous {
        background-color: #f1f1f1;
        color: black;
    }

    .next {
        background-color: #4CAF50;
        color: white;
    }

    .round {
        border-radius: 50%;
    }
</style>
<body>
    <div class="maindiv">
        <img src="https://maqsoftware.com/img/MAQSoftware.png" alt="logo" align="middle" style="width:200px;height:75px;">
        <p class="header " style="margin-left:15%; font-size:20px;">
            Power BI Embedded Report
        </p>
        <div align="right" style="width:90%;height:0px;">
            <button type="submit" class="edit" id="edit">Edit</button><br>
            <button type="submit" class="print" id="print">Print</button><br>
            <button type="submit" class="done" id="done" onclick="sendEmail()">Done</button>
        </div>
        <div id="dashboardContainer" style="width:65%; margin-left:15%; border:solid 5px #808080; height:650px"></div>
        <!-- Trigger/Open The Modal -->
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="embedprint" style="width:65%; margin-left:15%; border:solid 5px #808080; height:650px"></div>
                <div style="margin-top:5%; ">
                    <a href="#" onclick="previous()" class="previous round">&#8249;</a>
                    <a href="#" onclick="next()" class="next round">&#8250;</a>
                </div>
            </div>
        </div>
        <script>
// Get the modal
var modal = document.getElementById('myModal');

// Get the button that opens the modal
var btn = document.getElementById("print");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
        </script>
    </div>

    <script src="https://microsoft.github.io/PowerBI-JavaScript/demo/node_modules/jquery/dist/jquery.js"></script>
    <script src="https://microsoft.github.io/PowerBI-JavaScript/demo/node_modules/powerbi-client/dist/powerbi.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"></script>
    <script type="text/javascript">
        /// <disable>JS2032, JS2074, JS3058, JS2076, JS2024, JS3092</disable>
        "use strict";
        var oCommon = {};
        var startTime;
        var endTime;
        var Time;
        var show = '';
        var token = '';
        var count = 0;
        var pageChanged = 0;
        var dataSelected = 0;
        var filterApplied = 0;
        var x = location.search.toString();
        var reportid = x.split('&')[0].split('=')[1];
        var pagesarr = [];
        var txtAccessToken;
        var models = window['powerbi-client'].models;
        var permissions = models.Permissions.All;
        var embedConfiguration;
        var tokenTime = 0;
        var i = 0;
        var config ;
        var $embedprint ;
        var printreport;
        // ADAL configuration object
        oCommon.config = {
            instance: "https://login.microsoftonline.com/",
            tenant: "e4d98dd2-9199-42e5-ba8b-da3e763ede2e",
            clientId: "d4278e27-2bce-46a6-9c2b-f1a491800a8c",
            postLogoutRedirectUri: window.location.origin,
            cacheLocation: "localStorage",
        };

        // Authentication context
        oCommon.authContext = new AuthenticationContext(oCommon.config);
        var bIsCallback = oCommon.authContext.isCallback(window.location.hash);
        oCommon.authContext.handleWindowCallback();

        // Log any error if during login
        oCommon.loginError = oCommon.authContext.getLoginError();
        if (oCommon.loginError) {
            console.log(oCommon.loginError);
            oCommon.authContext.login();
        }

        // Redirect user to login
        if (bIsCallback && !oCommon.authContext.getLoginError()) {
            window.location = oCommon.authContext._getItem("adal.login.request");
        }

        // Check Login Status

        oCommon.user = oCommon.authContext.getCachedUser();
        console.log(oCommon)
        oCommon.authContext.acquireToken("https://analysis.windows.net/powerbi/api", function (oError, sToken) {
            tokenTime = Date.now();
            console.log(sToken)
            // Handle ADAL Errors
            if (oError || !sToken) {
                console.log("ADAL Error Occurred: " + oError);
                // Handle error
                oCommon.authContext.login();
                return;
            }
            // embed using sToken
            var txtAccessToken = sToken;
            startTime = Date.now();

            var models = window['powerbi-client'].models;
            var permissions = models.Permissions.All;
            //var viewMode = models.ViewMode.Edit;

            var embedConfiguration = {
                type: 'report',
                tokenType: models.TokenType.Aad,
                accessToken: sToken,
                embedUrl: 'https://app.powerbi.com/reportEmbed'+x,
                id: reportid,
                permissions: models.Permissions.ReadWrite,
                viewMode: models.ViewMode.View,
                settings: {
                    extensions: [
                        {
                           command: {
                                name: "Analysis",
                                title: "Start Analysis",
                                icon: "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMjEuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMiA1MTI7IiB4bWw6c3BhY2U9InByZXNlcnZlIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CjxnPgoJPHBhdGggc3R5bGU9ImZpbGw6IzQ4NEI2MzsiIGQ9Ik01MDcuNDc0LDM3Ni4xNTlMNTA3LjQ3NCwzNzYuMTU5Yy02LjAzNSw2LjAzNS0xNS44MTksNi4wMzUtMjEuODUzLDBMMzg0LjM2NiwyNzQuOTA0ICAgbDIxLjg1My0yMS44NTNsMTAxLjI1NCwxMDEuMjU0QzUxMy41MDksMzYwLjM0LDUxMy41MDksMzcwLjEyNCw1MDcuNDc0LDM3Ni4xNTl6Ii8+Cgk8cGF0aCBzdHlsZT0iZmlsbDojRDhENUVEOyIgZD0iTTMyMC41MDcsNTEySDRjLTIuMjA5LDAtNC0xLjc5MS00LTRWNjAuNjZjMC0yLjIwOSwxLjc5MS00LDQtNGgzMTYuNTA3YzIuMjA5LDAsNCwxLjc5MSw0LDRWNTA4ICAgQzMyNC41MDcsNTEwLjIwOSwzMjIuNzE2LDUxMiwzMjAuNTA3LDUxMnoiLz4KCTxwYXRoIHN0eWxlPSJmaWxsOiNGRjJDNUM7IiBkPSJNOTEuMjkyLDQ3Ni4xNzdIMzcuNDgxYy0yLjIwOSwwLTQtMS43OTEtNC00VjMxMy4yODhjMC0yLjIwOSwxLjc5MS00LDQtNGg1My44MTEgICBjMi4yMDksMCw0LDEuNzkxLDQsNHYxNTguODg5Qzk1LjI5Miw0NzQuMzg3LDkzLjUwMSw0NzYuMTc3LDkxLjI5Miw0NzYuMTc3eiIvPgoJPHBhdGggc3R5bGU9ImZpbGw6I0ZGRDY1OTsiIGQ9Ik0xODguMTI5LDQ3Ni4xNzdoLTUzLjgxMWMtMi4yMDksMC00LTEuNzkxLTQtNHYtMjIwLjdjMC0yLjIwOSwxLjc5MS00LDQtNGg1My44MTEgICBjMi4yMDksMCw0LDEuNzkxLDQsNHYyMjAuN0MxOTIuMTI5LDQ3NC4zODcsMTkwLjMzOCw0NzYuMTc3LDE4OC4xMjksNDc2LjE3N3oiLz4KCTxwYXRoIHN0eWxlPSJmaWxsOiM0RkM2RjU7IiBkPSJNMjg3LjAyNiw0NzYuMTc3aC01My44MTFjLTIuMjA5LDAtNC0xLjc5MS00LTRWMjc0LjE0MWMwLTIuMjA5LDEuNzkxLTQsNC00aDUzLjgxMSAgIGMyLjIwOSwwLDQsMS43OTEsNCw0djE5OC4wMzZDMjkxLjAyNiw0NzQuMzg3LDI4OS4yMzUsNDc2LjE3NywyODcuMDI2LDQ3Ni4xNzd6Ii8+Cgk8cGF0aCBzdHlsZT0iZmlsbDojRTYyNzUzOyIgZD0iTTY0LjM4NiwzMDkuMjg4djE2Ni44ODloMjYuOTA1YzIuMjA5LDAsNC0xLjc5MSw0LTRWMzEzLjI4OGMwLTIuMjA5LTEuNzkxLTQtNC00SDY0LjM4NnoiLz4KCTxwYXRoIHN0eWxlPSJmaWxsOiNGRkJENTQ7IiBkPSJNMTYxLjIyMywyNDcuNDc3djIyOC43aDI2LjkwNWMyLjIwOSwwLDQtMS43OTEsNC00di0yMjAuN2MwLTIuMjA5LTEuNzkxLTQtNC00SDE2MS4yMjN6Ii8+Cgk8cGF0aCBzdHlsZT0iZmlsbDojM0JCM0UzOyIgZD0iTTI2MC4xMjEsMjcwLjE0MXYyMDYuMDM2aDI2LjkwNWMyLjIwOSwwLDQtMS43OTEsNC00VjI3NC4xNDFjMC0yLjIwOS0xLjc5MS00LTQtNEgyNjAuMTIxeiIvPgoJPGc+CgkJPHBhdGggc3R5bGU9ImZpbGw6IzUwNTM2RTsiIGQ9Ik00NS44NDMsMTA1LjYwMWgyMjYuNjRjNC4xNDMsMCw3LjUtMy4zNTgsNy41LTcuNXMtMy4zNTctNy41LTcuNS03LjVINDUuODQzICAgIGMtNC4xNDMsMC03LjUsMy4zNTgtNy41LDcuNVM0MS43LDEwNS42MDEsNDUuODQzLDEwNS42MDF6Ii8+CgkJPHBhdGggc3R5bGU9ImZpbGw6IzUwNTM2RTsiIGQ9Ik0yNzIuNDgyLDEyNC45NEg0NS44NDNjLTQuMTQzLDAtNy41LDMuMzU4LTcuNSw3LjVzMy4zNTcsNy41LDcuNSw3LjVoMjI2LjY0ICAgIGM0LjE0MywwLDcuNS0zLjM1OCw3LjUtNy41UzI3Ni42MjUsMTI0Ljk0LDI3Mi40ODIsMTI0Ljk0eiIvPgoJCTxwYXRoIHN0eWxlPSJmaWxsOiM1MDUzNkU7IiBkPSJNMjcyLjQ4MiwxNTkuMjhINDUuODQzYy00LjE0MywwLTcuNSwzLjM1OC03LjUsNy41czMuMzU3LDcuNSw3LjUsNy41aDIyNi42NCAgICBjNC4xNDMsMCw3LjUtMy4zNTgsNy41LTcuNVMyNzYuNjI1LDE1OS4yOCwyNzIuNDgyLDE1OS4yOHoiLz4KCQk8cGF0aCBzdHlsZT0iZmlsbDojNTA1MzZFOyIgZD0iTTEwMy42MTUsMTkzLjYxOUg0NS44NDNjLTQuMTQzLDAtNy41LDMuMzU4LTcuNSw3LjVzMy4zNTcsNy41LDcuNSw3LjVoNTcuNzcyICAgIGM0LjE0MywwLDcuNS0zLjM1OCw3LjUtNy41UzEwNy43NTgsMTkzLjYxOSwxMDMuNjE1LDE5My42MTl6Ii8+Cgk8L2c+CgkKCQk8ZWxsaXBzZSB0cmFuc2Zvcm09Im1hdHJpeCgwLjcwNzEgLTAuNzA3MSAwLjcwNzEgMC43MDcxIC0yOC43OTk0IDI1OC4wNjk4KSIgc3R5bGU9ImZpbGw6IzUwNTM2RTsiIGN4PSIyOTcuMTE4IiBjeT0iMTYzLjc5OSIgcng9IjE2My43OTkiIHJ5PSIxNjMuNzk5Ii8+Cgk8cGF0aCBzdHlsZT0iZmlsbDojQjVGQ0ZGOyIgZD0iTTM5MS4wODgsMjU3Ljc2OWMtNTEuODE1LDUxLjgxNS0xMzYuMTI0LDUxLjgxNS0xODcuOTQsMHMtNTEuODE1LTEzNi4xMjQsMC0xODcuOTQgICBzMTM2LjEyNC01MS44MTUsMTg3Ljk0LDBTNDQyLjkwMywyMDUuOTU0LDM5MS4wODgsMjU3Ljc2OXoiLz4KCTxwYXRoIHN0eWxlPSJmaWxsOiM3MUY2RkM7IiBkPSJNMzkxLjA4OCw2OS44MjljLTI5LjgzNi0yOS44MzYtNzAuNDQ2LTQyLjQ4Ny0xMDkuNDIzLTM3Ljk2MyAgIGMyOC43MTIsMy4zMzMsNTYuNTM4LDE1Ljk4NCw3OC41MTcsMzcuOTYzYzUxLjgxNSw1MS44MTUsNTEuODE1LDEzNi4xMjQsMCwxODcuOTRjLTIxLjk3OSwyMS45NzktNDkuODA1LDM0LjYzLTc4LjUxNywzNy45NjMgICBjMzguOTc3LDQuNTI0LDc5LjU4Ny04LjEyNywxMDkuNDIzLTM3Ljk2M0M0NDIuOTAzLDIwNS45NTQsNDQyLjkwMywxMjEuNjQ0LDM5MS4wODgsNjkuODI5eiIvPgo8L2c+CgoKCgoKCgoKCgoKCgoKCjwvc3ZnPgo=",
                                extend:
                                    {
                                        visualOptionsMenu: {
                                            title: "Start Analysis"
                                        },
                                        visualContextMenu: {
                                            title: "Drill through"
                                        },

                                    }
                            }

                        }
                    ],

                    commands: [
            {
                exportData: {
                    displayOption: models.CommandDisplayOption.Disabled,
                }
            }
                    ]
                },
            };

            var $reportContainer = $('#dashboardContainer');
            var report = powerbi.embed($reportContainer.get(0), embedConfiguration);
            var config = {
                type: 'report',
                tokenType: models.TokenType.Aad,
                accessToken: sToken,
                embedUrl: 'https://app.powerbi.com/reportEmbed' + x,
                id: reportid,
                permissions: models.Permissions.ReadWrite,
                viewMode: models.ViewMode.View,
                settings: {
                    navContentPaneEnabled: false
                }

            };

             $embedprint = $('#embedprint');
            // powerbi.reset(embedprint);

             printreport = powerbi.embed($embedprint.get(0), config);

            console.log(report)
            report.on('rendered', function (event) {
              //  console.log(command);
                report.getPages().then(function (pages) {
                    for (i = 0; i < pages.length ; i++) {
                        pagesarr.push(pages[i]);
                        console.log(pagesarr)
                    }
                    count++;
                    if (pageChanged == 1 || dataSelected == 1 || filterApplied==1) {
                        $('.text').remove();
                        endTime = Date.now();
                        Time = ((endTime - startTime) / 1000).toFixed(2);
                        tokenTime = (tokenTime / 1000).toFixed(2);
                        show = '<div class="text"><p style="margin-left:15%; font-size:20px;">Report Load Time is: ' + Time + ' seconds</p></div>';
                        $('.maindiv').append(show);


                    }
                    pageChanged = 0;
                    dataSelected = 0;
                });
            });
            report.on('commandTriggered', function (command) {
                console.log(command);
                window.open('https://github.com/Microsoft/PowerBI-JavaScript/wiki/Commands', '_newtab');

            })
            function reloadreport() {

                var $reportContainer = $('#dashboardContainer');
                powerbi.embedNew($reportContainer.get(0), embedConfiguration);

            };

            $('.edit').on('click', function () {

                i++;
                if (i % 2 == 0) {
                    $('.edit').css('opacity', '1')
                    report.switchMode("view");
                }
                else {
                    $('.edit').css('opacity', '0.5')
                    report.switchMode("edit");
                }
            });

            report.on('pageChanged', function () {
                pageChanged = 1;
                if (count != 0)
                    startTime = Date.now();
            });
            report.on('dataSelected', function () {
                dataSelected = 1;
                startTime = Date.now();
            });
            report.on('filtersApplied', function () {
                filterApplied= 1;
                startTime = Date.now();
            });




        });


        function previous() {

            var currentPage;
            for (i = 0; i < pagesarr.length; i++) {
                if (pagesarr[i].isActive) {
                    currentPage = i;
                }
            }
            var activepage;
            activepage = currentPage - 1;
            pagesarr[activepage].isActive = true;
            var displayname = pagesarr[displayname]
            oCommon.authContext.acquireToken("https://analysis.windows.net/powerbi/api", function (oError, sToken) {
                var config = {
                    type: 'report',
                    tokenType: models.TokenType.Aad,
                    accessToken: sToken,
                    embedUrl: 'https://app.powerbi.com/reportEmbed' + x,
                    id: reportid,
                    pageName: pagesarr[i].name,
                    permissions: models.Permissions.ReadWrite,
                    viewMode: models.ViewMode.View,
                    settings: {
                        navContentPaneEnabled: false
                    }

                };

                $embedprint = $('#embedprint');
                powerbi.reset(embedprint);

                printreport = powerbi.embed($embedprint.get(0), config);
            });
        }
        function next() {

            var currentPage;
            for (i = 0; i < pagesarr.length; i++) {
                if (pagesarr[i].isActive === true) {
                    currentPage = i;

                }
            }
            var activepage;
            activepage = currentPage + 1;
            var displayname = pagesarr[displayname]
            oCommon.authContext.acquireToken("https://analysis.windows.net/powerbi/api", function (oError, sToken) {
                var config = {
                    type: 'report',
                    tokenType: models.TokenType.Aad,
                    accessToken: sToken,
                    embedUrl: 'https://app.powerbi.com/reportEmbed' + x,
                    id: reportid,
                    pageName: pagesarr[i].name,
                    permissions: models.Permissions.ReadWrite,
                    viewMode: models.ViewMode.View,
                    settings: {
                        navContentPaneEnabled: false
                    }

                };

                $embedprint = $('#embedprint');
                powerbi.reset(embedprint);

                printreport = powerbi.embed($embedprint.get(0), config);
            });
            }

        function sendEmail() {
            $.ajax({
                url: 'http://localhost:63380/api/getvisualdata/sendMail',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                method: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ to: to, subject: subject, content: content}),
                dataType: "json",
                success: function (response) {
                    console.log("success");
                },
                error: function (error) {
                    console.log(error);
                }
          });
        }

    </script>
</body>
</html>
