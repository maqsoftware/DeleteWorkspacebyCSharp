<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
</head>

<body>
    <div class="maindiv">
        <img src="https://maqsoftware.com/img/MAQSoftware.png" alt="logo" align="middle" style="width:200px;height:75px;">

        <p class="header " style="margin-left:15%; font-size:20px;">
            Power BI Embedded Report
        </p>
        <div id="questionDiv" style="display:none">
            <p style="margin-left:15%; font-size:20px;">
                Question
                <input style="margin-left:1%; font-size:20px;" type="text" name="question" id="question">
                <input type="radio" name="qnaMode" value="Interactive" id="InteractiveNoQuestion" onclick="qna()">Interactive
                <input type="radio" name="qnaMode" value="ResultOnly" id="ResultOnly" onclick="qna()"> Result Only<br />

        </div>
        <div align="right" style="width:90%;height:0px;">
            <button type="submit" class="edit" id="edit" onclick="Embed()">Report</button><br>
            <button type="submit" class="edit3" id="edit3" onclick="qna()">Q&A</button><br>

        </div>
        <div id="dashboardContainer" display="none" style="width:65%; margin-left:15%;margin-top:1%;  height:650px"></div>

    </div>


    <script src="https://microsoft.github.io/PowerBI-JavaScript/demo/node_modules/jquery/dist/jquery.js"></script>
    <script src="https://microsoft.github.io/PowerBI-JavaScript/demo/node_modules/powerbi-client/dist/powerbi.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"></script>
    <link href="~/Content/QandADemo.css" rel="stylesheet" />
    <script type="text/javascript">
        /// <disable>JS2032, JS2074, JS3058, JS2076, JS2024, JS3092</disable>


        "use strict";
        var oCommon = {};
        var token = '';
        var txtAccessToken;
        var models = window['powerbi-client'].models;
        var permissions = models.Permissions.All;
        var embedConfiguration;
        var tokenTime = 0;
        var x = location.search.toString();
        var reportid = x.split('&')[0].split('=')[1];
        var config ;

        //// ADAL configuration object
        //oCommon.config = {
        //    instance: "https://login.microsoftonline.com/",
        //    tenant: "e4d98dd2-9199-42e5-ba8b-da3e763ede2e",
        //    //clientId: "54de3fe7-aded-4396-89ad-921a1ba94d63",
        //    clientId: "d4278e27-2bce-46a6-9c2b-f1a491800a8c",
        //    postLogoutRedirectUri: window.location.origin,
        //    cacheLocation: "localStorage",
        //};

        //// Authentication context
        //oCommon.authContext = new AuthenticationContext(oCommon.config);
        //var bIsCallback = oCommon.authContext.isCallback(window.location.hash);
        //oCommon.authContext.handleWindowCallback();

        //// Log any error if during login
        //oCommon.loginError = oCommon.authContext.getLoginError();
        //if (oCommon.loginError) {
        //    console.log(oCommon.loginError);
        //    oCommon.authContext.login();
        //}

        //// Redirect user to login
        //if (bIsCallback && !oCommon.authContext.getLoginError()) {
        //    window.location = oCommon.authContext._getItem("adal.login.request");
        //}

        //// Check Login Status


        //oCommon.user = oCommon.authContext.getCachedUser();
        //console.log(oCommon);


        $(document).ready(function () {

            Embed();
        });
        function Embed() {

            $('#radioButtons').css('display', 'none');
            $('#questionDiv').css('display', 'none');
           
            //oCommon.authContext.acquireToken("https://analysis.windows.net/powerbi/api", function (oError, sToken) {
                let sToken = document.cookie.substr(document.cookie.indexOf('=') + 1);
                tokenTime = Date.now();

                // Handle ADAL Errors
                //if (!sToken) {
                //    console.log("ADAL Error Occurred: " + oError);
                //    // Handle error
                //    oCommon.authContext.login();
                //    return;
                //}
                // embed using sToken
                var txtAccessToken = sToken;

                //Embedding Logic

                var models = window['powerbi-client'].models;
                var permissions = models.Permissions.All;
                var embedConfiguration = {
                    type: 'report',
                    tokenType: models.TokenType.Aad,
                    accessToken: sToken,
                    embedUrl: 'https://app.powerbi.com/reportEmbed?reportId=88771e09-26ad-4874-9271-ebe851540fba&groupId=a65fda33-e0aa-43c5-8c73-e0ada42f5acd',
                    id: reportid,
                    permissions: permissions,
                    viewMode: models.ViewMode.View
                };
               // $('#dashboardContainer').css('display', 'block');
                var $reportContainer = $('#dashboardContainer');

                var report = powerbi.embedNew($reportContainer.get(0), embedConfiguration);
        }


        function qna() {


            $('#radioButtons').css('display', 'block');
            $('#questionDiv').css('display', 'block');
            var qnaMode = $("input[name='qnaMode']:checked").val();
            var txtQuestion = $('#question').val();
            //oCommon.authContext.acquireToken("https://analysis.windows.net/powerbi/api", function (oError, sToken) {
            let sToken = document.cookie.substr(document.cookie.indexOf('=') + 1);
            var myHeaders = new Headers();
            myHeaders.append("Authorization", `Bearer ${sToken}`);
            myHeaders.append("Content-Type", "application/json");
            var raw = "{\n  \"datasets\": [\n    {\n      \"id\": \"4cb480e5-01e1-4ffe-9aa6-c8e2c2ff57c8\"\n    }\n  ],\n}";

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
        };
        let accTokenEmbed;
        fetch("https://api.powerbi.com/v1.0/myorg/GenerateToken", requestOptions)
          .then(response => response.json().then(res=> {
              accTokenEmbed = res.token;
              var config = {
                  type: 'qna',
                  tokenType: models.TokenType.Embed,
                  accessToken: accTokenEmbed,
                  //embedUrl: 'https://app.powerbi.com/qnaEmbed',
                  //datasetIds: ['fdae0721-4f5b-462d-9024-8c6cab6580e6'],

                  //embedUrl: 'https://app.powerbi.com/qnaEmbed?groupId=06d2c1f9-4179-456c-b41d-24eae4c7b935',
                  //datasetIds: ['0bfb390f-2019-4504-aefa-6f7b1085960c'],

                  embedUrl: 'https://app.powerbi.com/qnaEmbed?groupId=a65fda33-e0aa-43c5-8c73-e0ada42f5acd',
                  datasetIds: ['4cb480e5-01e1-4ffe-9aa6-c8e2c2ff57c8'],

                  viewMode: models.QnaMode[qnaMode],
                  question: txtQuestion//'what is the total invoice by item category as line chart',// optional in case of interactive mode and mandatory in case of ResultOnly mode
              };
              var $reportContainer = $('#dashboardContainer');
              var report = powerbi.embed($reportContainer.get(0), config);
          }))
          .catch(error => console.log('error', error));
          
        }


    </script>
</body>
</html>